name: spoolbuddy

services:
  backend-test:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: backend-test
    volumes:
      - ./backend:/app
    environment:
      TESTING: "1"
      SPOOLBUDDY_DATABASE_PATH: ":memory:"
    command: ["pytest", "tests/", "-v", "--tb=short", "-p", "no:cacheprovider"]

  frontend-test:
    build:
      context: .
      dockerfile: Dockerfile.test
      target: frontend-test
    volumes:
      - ./frontend:/app/frontend
      - /app/frontend/node_modules
    command: ["npm", "test", "--", "--run"]

  integration:
    build: .
    network_mode: host
    environment:
      SPOOLBUDDY_DATABASE_PATH: ":memory:"
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000/api/spools"]
      interval: 5s
      timeout: 5s
      retries: 10
      start_period: 10s
